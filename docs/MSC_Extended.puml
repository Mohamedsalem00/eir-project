@startuml
!theme plain
title EIR Multi-Protocoles - Scénarios d'Intégration

actor "Utilisateur" as U
participant "Téléphone" as T
participant "App Web" as WEB
participant "MSC" as MSC
participant "MME" as MME
participant "DMS" as DMS
participant "EIR" as EIR
participant "DB" as DB

note over EIR : Protocoles Actifs:\nREST • SS7 • Diameter • DMS

group REST (Web/Mobile)
    U -> T : Ouvre application
    T -> WEB : Demande vérification IMEI
    WEB -> EIR : POST /verify_imei?protocol=rest
    note right : {"imei": "123456789012345"}
    
    EIR -> DB : Recherche IMEI
    EIR --> WEB : {"status": "success", "imei_status": "whitelisted"}
    WEB --> T : Résultat affiché
    T --> U : IMEI validé
end

group SS7 (MSC/VLR)
    U -> T : Allume téléphone
    T -> MSC : Demande attachement réseau
    MSC -> EIR : POST /verify_imei?protocol=ss7
    note right : {"imei": "123456789012345", "msisdn": "33123456789"}
    
    EIR -> DB : Log requête
    EIR --> MSC : {"status": "accepted", "processing_mode": "fire_and_forget"}
    
    alt IMEI autorisé
        MSC -> T : Connexion autorisée
        T --> U : Réseau disponible
    else IMEI bloqué
        MSC -> T : Connexion refusée
        T --> U : Pas de réseau
    end
end

group Diameter (MME/SGSN)
    U -> T : Active données LTE
    T -> MME : Attach Request
    MME -> EIR : POST /verify_imei?protocol=diameter
    note right : {"imei": "123456789012345", "session_id": "abc123"}
    
    EIR -> DB : Recherche IMEI
    EIR --> MME : {"message_type": "Equipment-Status-Answer", "Result-Code": 2001}
    MME -> T : Attach Accept/Reject
    T --> U : Données LTE activées
end

group DMS Sync
    DMS -> EIR : POST /sync-device
    note right : {"appareils": [{"imei": "123456789012345", "marque": "Samsung"}]}
    
    EIR -> DB : UPDATE/INSERT appareils
    EIR --> DMS : {"statut": "succès", "créés": 1, "durée_ms": 62.56}
end

@enduml